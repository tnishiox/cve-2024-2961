/*

CVE-2024-2961 vulnerability tester, based on
https://www.ambionics.io/blog/iconv-cve-2024-2961-p1

*/
#include <iconv.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <ctype.h>
#include <unistd.h>
int check()
{
    iconv_t cd = iconv_open("ISO-2022-CN-EXT", "UTF-8");
    char input[0x10] = "AAAAAåŠ„";
    char output[0x10] = {0};
    char *pinput = input;
    char *poutput = output;
    // Same size for input and output buffer
    size_t sinput = strlen(input);
    size_t soutput = sinput;
    iconv(cd, &pinput, &sinput, &poutput, &soutput);
    return soutput;
}
int main(int argc, char *argv[])
{
    if (argc >= 2) {
        int seconds = atoi(argv[1]);
        printf("Pause for %d seconds.\n", seconds);
        printf("Run 'kcarectl --lib-update' in the meantime.\n");
        sleep(seconds);
    }
    printf(check() < 0 ? "system is vulnerable\n" : "system is safe\n");
    return 0;
}
